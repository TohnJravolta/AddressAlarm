<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AddressAlarm ‚Äì On-device safety alerts for risky addresses</title>
    <meta
      name="description"
      content="AddressAlarm is an open-source Android accessibility companion that warns you about risky addresses from your personal watchlist."
    />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&family=Press+Start+2P&display=swap');

      :root {
        /* Dark Theme (Default) */
        --primary-glow: #00ff9d;
        --secondary-glow: #ff00c1;
        --background: #121212;
        --surface: #1e1e1e;
        --text: #e0e0e0;
        --text-header: #ffffff;
        --muted: #888888;
        --border-color: rgba(0, 255, 157, 0.3);
        --max-width: 960px;
        --border-radius: 8px;
      }

      body.light-mode {
        /* Light Theme */
        --primary-glow: #006442;
        --secondary-glow: #a0006d;
        --background: #f5f5f5;
        --surface: #ffffff;
        --text: #212121;
        --text-header: #000000;
        --muted: #757575;
        --border-color: #e0e0e0;
      }

      * {
        box-sizing: border-box;
      }

      html {
        scroll-behavior: smooth;
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
      }

      body {
        margin: 0;
        font-family: 'Lexend', sans-serif; /* Dyslexia-friendly font */
        background: var(--background);
        color: var(--text);
        line-height: 1.8;
        background-image: radial-gradient(var(--muted) 0.5px, transparent 0.5px);
        background-size: 15px 15px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden; /* Prevent horizontal scroll */
        max-width: 100%;
      }

      a {
        color: var(--primary-glow);
        text-decoration: none;
        transition: all 0.2s ease-in-out;
      }

      a:hover,
      a:focus {
        color: #fff;
        text-shadow: 0 0 10px var(--primary-glow);
      }

      header {
        background: rgba(18, 18, 18, 0.7);
        backdrop-filter: blur(10px);
        position: sticky;
        top: 0;
        z-index: 1000;
        border-bottom: 1px solid var(--border-color);
      }

      .navbar {
        max-width: var(--max-width);
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1.5rem;
        gap: 2rem; /* Increased gap */
      }

      .navbar strong {
        font-family: 'Press Start 2P', cursive; /* Retro pixel font */
        font-size: 1rem;
        color: var(--text-header);
        text-shadow: 0 0 5px var(--primary-glow);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        white-space: nowrap; /* Prevent logo text from wrapping */
      }

      #bouncing-logo {
        display: inline-block;
        animation: bounce 2s infinite ease-in-out;
      }

      @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
      }

      .nav-controls {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .nav-links {
        display: flex;
        gap: 1.5rem;
      }

      #theme-switcher {
        background: none;
        border: 1px solid var(--muted);
        color: var(--text);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        border-radius: var(--border-radius);
        transition: all 0.2s ease;
        line-height: 1; /* Aligns emoji better */
      }

      #theme-switcher:hover {
        color: var(--primary-glow);
        border-color: var(--primary-glow);
      }

      body.light-mode #theme-switcher {
        border-color: var(--border-color);
        color: var(--text);
      }

      body.light-mode #theme-switcher:hover {
        color: var(--primary-glow);
        border-color: var(--primary-glow);
      }

      .nav-links a {
        font-family: 'Press Start 2P', cursive;
        font-size: 0.8rem;
        text-decoration: none;
        color: var(--text);
        transition: all 0.2s ease;
      }

      .nav-links a:hover,
      .nav-links a:focus {
        color: var(--primary-glow);
        text-shadow: 0 0 8px var(--primary-glow);
        text-decoration: none;
      }

      .hero {
        padding: 6rem 1.5rem 5rem;
        text-align: center;
      }

      .hero h1 {
        font-family: 'Press Start 2P', cursive;
        font-size: clamp(1.8rem, 5vw, 3rem);
        color: var(--text-header);
        text-shadow: 0 0 15px var(--primary-glow), 0 0 25px var(--primary-glow);
        margin-bottom: 1.5rem;
        line-height: 1.4;
      }

      .hero p {
        max-width: 720px;
        margin: 0 auto 2.5rem;
        color: var(--text);
        font-size: 1.1rem;
      }

      .small-print {
        max-width: 640px;
        margin: 1.5rem auto 0;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .button {
        display: inline-block;
        padding: 1rem 2.5rem;
        background: transparent;
        color: var(--primary-glow);
        border: 2px solid var(--primary-glow);
        border-radius: var(--border-radius);
        font-weight: 600;
        font-family: 'Press Start 2P', cursive;
        text-decoration: none;
        box-shadow: 0 0 15px rgba(0, 255, 157, 0.3);
        transition: all 0.2s ease;
      }

      .button:hover,
      .button:focus {
        background: var(--primary-glow);
        color: var(--background);
        box-shadow: 0 0 25px rgba(0, 255, 157, 0.6);
        text-shadow: none;
        transform: translateY(-3px);
        text-decoration: none;
      }

      section {
        padding: 5rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
      }
      section:last-of-type {
          border-bottom: none;
      }

      .section-inner {
        max-width: var(--max-width);
        margin: 0 auto;
      }

      section h2 {
          text-align: center;
          font-family: 'Press Start 2P', cursive;
          font-size: 2rem;
          color: var(--text-header);
          text-shadow: 0 0 10px var(--secondary-glow);
          margin-bottom: 3rem;
      }

      .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 2rem;
      }

      .card {
        background: var(--surface);
        border-radius: var(--border-radius);
        padding: 2rem;
        border: 1px solid var(--border-color);
        box-shadow: inset 0 0 15px rgba(0, 255, 157, 0.1), 0 0 5px rgba(0, 255, 157, 0.1);
        transition: all 0.3s ease;
      }

      .card:hover {
          transform: translateY(-5px) scale(1.02);
          box-shadow: inset 0 0 20px rgba(0, 255, 157, 0.2), 0 0 15px rgba(0, 255, 157, 0.3);
      }

      .card h3 {
        margin-top: 0;
        font-size: 1.25rem;
        color: var(--primary-glow);
        font-family: 'Press Start 2P', cursive;
        font-size: 1rem;
      }

      #how-it-works ol {
          list-style: none;
          padding-left: 0;
          max-width: 600px;
          margin: 2rem auto;
      }

      #how-it-works li {
          position: relative;
          padding: 1rem;
          margin-bottom: 1.5rem;
          border: 1px dashed var(--border-color);
          border-radius: var(--border-radius);
      }

      .list-inline {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
        padding-left: 0;
        list-style: none;
        text-align: center;
      }

      .list-inline li {
          background: var(--surface);
          padding: 0.5rem 1rem;
          border-radius: var(--border-radius);
          border: 1px solid var(--border-color);
          font-weight: 600;
          color: var(--primary-glow);
          flex: 1 1 220px;
          max-width: min(100%, 320px);
          word-break: break-word;
      }

      .footer {
        background: var(--background);
        color: var(--muted);
        text-align: center;
        padding: 3rem 1.5rem;
        border-top: 1px solid var(--border-color);
      }

      .footer a {
        color: var(--primary-glow);
      }

      .footer p {
          margin: 0.5rem 0;
      }

      .trail {
          position: absolute;
          height: 8px;
          width: 8px;
          border-radius: 4px;
          background: var(--primary-glow);
          pointer-events: none;
          box-shadow: 0 0 10px var(--primary-glow);
      }

      .tap-particle {
          position: absolute;
          height: 10px;
          width: 10px;
          border-radius: 50%;
          background: rgba(0, 255, 157, 0.9);
          pointer-events: none;
          opacity: 0.85;
          transform: translate(-50%, -50%);
          animation: tapBurst 600ms ease-out forwards;
          box-shadow: 0 0 12px rgba(0, 255, 157, 0.55);
      }

      @keyframes tapBurst {
          0% {
              transform: translate(-50%, -50%) scale(1);
              opacity: 1;
          }
          100% {
              transform: translate(calc(-50% + var(--dx, 0px)), calc(-50% + var(--dy, 0px))) scale(0);
              opacity: 0;
          }
      }

      #music-player button {
        background: none;
        border: 1px solid var(--muted);
        color: var(--muted);
        font-family: 'Press Start 2P', cursive;
        font-size: 0.7rem;
        cursor: pointer;
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
      }

      #music-player button:hover {
        color: var(--primary-glow);
        border-color: var(--primary-glow);
        box-shadow: 0 0 10px var(--primary-glow);
      }

      /* --- Tooltip Styles --- */
      .tooltip {
        position: relative;
        cursor: help;
        border-bottom: 1px dashed var(--primary-glow);
        text-decoration: none;
        color: inherit;
      }
      .tooltip:hover {
        text-decoration: none;
      }
      .tooltip .tooltip-text {
        visibility: hidden;
        width: 220px;
        max-width: min(220px, calc(100vw - 2.5rem));
        background-color: var(--surface);
        color: var(--text);
        text-align: center;
        border-radius: var(--border-radius);
        padding: 10px;
        position: absolute;
        z-index: 10;
        bottom: 140%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        border: 1px solid var(--border-color);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        pointer-events: none;
        word-break: break-word;
      }
      .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }

      /* --- Light Theme Overrides --- */
      body.light-mode .navbar strong,
      body.light-mode .nav-links a:hover,
      body.light-mode .hero h1,
      body.light-mode section h2,
      body.light-mode .button:hover {
        text-shadow: none;
      }

      body.light-mode .button {
        background: var(--primary-glow);
        color: #fff;
        border-color: var(--primary-glow);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      body.light-mode .button:hover {
        background: #004d33; /* Darker shade for hover */
        border-color: #004d33;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      }

      body.light-mode .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      body.light-mode .card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }

      body.light-mode .trail {
        background: var(--primary-glow);
        box-shadow: none;
      }

      body.light-mode .tap-particle {
        box-shadow: 0 0 10px rgba(0, 128, 64, 0.35);
      }

      body.light-mode #music-player button:hover,
      body.light-mode #music-player button:focus {
        box-shadow: none;
      }

      @media (max-width: 768px) {
        .navbar {
          flex-direction: column;
          gap: 1.5rem;
        }
        .navbar strong {
          font-size: 0.85rem; /* Reduce font size on mobile */
        }
        .nav-controls {
          flex-direction: column;
          gap: 1.5rem;
        }
        .nav-links {
          flex-wrap: wrap;
          justify-content: center;
          gap: 1rem 1.5rem;
        }
      }

      @media (max-width: 600px) {
        .hero {
          padding: 5rem 1.25rem 4rem;
        }
        section {
          padding: 3.5rem 1.25rem;
        }
        .hero p,
        section p {
          font-size: 1rem;
        }
        .features-grid {
          gap: 1.5rem;
        }
        .card {
          padding: 1.75rem 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="navbar">
        <strong><span id="bouncing-logo" role="img" aria-label="Alarm emojis">üö® AddressAlarm üö®</span></strong>
        <div class="nav-controls">
          <div class="nav-links">
            <a href="#who-is-it-for">Who It's For</a>
            <a href="#features">Features</a>
            <a href="#how-it-works">How It Works</a>
            <a href="#download">Download</a>
            <a href="#roadmap">Roadmap</a>
            <a href="https://github.com/TohnJravolta/AAT" target="_blank" rel="noopener">GitHub</a>
          </div>
          <button id="theme-switcher" title="Toggle theme">‚òÄÔ∏è</button>
        </div>
      </nav>
    </header>

    <main>
      <section class="hero">
        <h1>A personal safety layer for any address.</h1>
        <p>
          AddressAlarm is a free, <a href="#open-source" class="tooltip">open-source<span class="tooltip-text">The app's code is public and can be reviewed by anyone. Click to learn more.</span></a> Android app that runs 100% on-device. It watches for addresses you've flagged and alerts you discreetly, helping you avoid risky, curious, or problematic locations before you commit.
        </p>
        <a class="button" href="https://github.com/TohnJravolta/AddressAlarm/releases/tag/v0.1.42-alpha" target="_blank" rel="noopener">
          Download the Latest APK
        </a>
        <p class="small-print">
          Current test build installs as <strong>FlagDrive</strong>. This is normal! The official name will be used in a future release.
          <br>Follow the <a href="docs/INSTALLATION.md">full installation guide</a> for setup help.
        </p>
      </section>

      <section id="who-is-it-for">
        <div class="section-inner">
          <h2>An essential tool for professionals and public</h2>
          <p>Originally built for gig workers, AddressAlarm is now a vital tool for anyone who navigates unfamiliar locations.</p>
          <div class="features-grid">
            <div class="card">
              <h3>üì¶ Gig &amp; Delivery Drivers</h3>
              <p>Keep a private log of difficult drop-offs, unsafe areas, or buildings with access codes.</p>
            </div>
            <div class="card">
              <h3>üëÆ Law Enforcement &amp; Social Workers</h3>
              <p>Get a heads-up when approaching a location with a known history of hostility or special circumstances.</p>
            </div>
            <div class="card">
              <h3>üè° Real Estate &amp; Contractors</h3>
              <p>Tag properties with notes about access, hazards, or client-specific information for your entire team.</p>
            </div>
            <div class="card">
              <h3>üôã‚Äç‚ôÄÔ∏è The General Public</h3>
              <p>A simple, private way to remember addresses you'd rather avoid for any reason.</p>
            </div>
          </div>
        </div>
      </section>

      <section id="features" class="alternate-bg">
        <div class="section-inner">
          <h2>Everything you need to stay aware</h2>
          <div class="features-grid">
            <div class="card">
              <h3>üîí Private &amp; Offline-First</h3>
              <p>All address matching happens locally. No data ever leaves your device. No servers, no tracking, period.</p>
            </div>
            <div class="card">
              <h3>üè∑Ô∏è Custom Flags &amp; Tags</h3>
              <p>Organize your watchlist with tags like "unsafe pet," "hostile," or "use back entrance" so you have context in the moment.</p>
            </div>
            <div class="card">
              <h3>üß† Smart, Debounced Alerts</h3>
              <p>Notifications are rate-limited to prevent alert fatigue. The overlay is clear, simple, and designed for at-a-glance safety.</p>
            </div>
            <div class="card">
              <h3>üì≤ Per-App Visibility</h3>
              <p>You choose exactly which apps AddressAlarm should monitor. It stays dormant until an app you've enabled is in the foreground.</p>
            </div>
            <div class="card">
              <h3>‚ÜîÔ∏è Import &amp; Export</h3>
              <p>Easily back up your flagged addresses or share your watchlist with trusted friends and colleagues.</p>
            </div>
             <div class="card">
              <h3>‚úÖ You're In Control</h3>
              <p>This tool is a memory aid, not automation. It gives you information so you can make the final choice. It never auto-declines or accepts jobs.</p>
            </div>
          </div>
        </div>
      </section>

      <section id="how-it-works">
        <div class="section-inner">
          <h2>Getting Started is Simple</h2>
          <ol>
            <li><strong>Download the APK</strong> from the latest GitHub release.</li>
            <li><strong>Install the app</strong> and enable the "FlagDrive" accessibility service in your phone's settings.</li>
            <li><strong>Build your watchlist</strong> by adding addresses, notes, and tags.</li>
            <li><strong>Select which apps to monitor</strong> (e.g., Google Maps, Uber Driver).</li>
            <li><strong>Get alerted!</strong> When a flagged address appears in a monitored app, a warning overlay will appear.</li>
          </ol>
          <p>
            Need a hand? Our detailed <a href="docs/INSTALLATION.md">Installation Guide</a> has step-by-step walkthroughs for Pixel, Samsung, and other devices.
          </p>
        </div>
      </section>

      <section id="download" class="alternate-bg">
        <div class="section-inner" style="text-align: center;">
            <h2>Download AddressAlarm</h2>
            <p>The app is free, <a href="#open-source" class="tooltip">open-source<span class="tooltip-text">The app's code is public and can be reviewed by anyone. Click to learn more.</span></a>, and ready to install.</p>
            <a class="button" href="https://github.com/TohnJravolta/AddressAlarm/releases/tag/v0.1.42-alpha" target="_blank" rel="noopener">
              Download v0.1.42-alpha
            </a>
            <p class="small-print">Requires Android 8.0 (Oreo) or newer.</p>
        </div>
      </section>

      <section id="roadmap">
        <div class="section-inner">
          <h2>What‚Äôs Next?</h2>
          <p>AddressAlarm is actively developed. Here are some of the major features planned for the future:</p>
          <ul class="list-inline">
            <li>Fuzzy address matching (e.g., "Apt 4B" vs "Unit 4B")</li>
            <li>Encrypted on-device storage</li>
            <li>Optional voice and TTS alerts</li>
            <li>In-app onboarding tour for new users</li>
            <li>Distribution via F-Droid</li>
          </ul>
          <p>
            See the <a href="ROADMAP.md">full roadmap</a> for more, or suggest a feature on
            <a href="https://github.com/TohnJravolta/AAT/issues" target="_blank" rel="noopener">GitHub</a>.
          </p>
        </div>
      </section>

      <section id="open-source">
        <div class="section-inner">
          <h2>What is Open Source?</h2>
          <p style="text-align: center; max-width: 720px; margin-left: auto; margin-right: auto;">
            AddressAlarm is a <span class="tooltip">FOSS<span class="tooltip-text">Free and Open Source Software</span></span> project. That means it's more than just free of charge‚Äîit's built on a foundation of freedom, transparency, and community.
          </p>
          <div class="features-grid" style="margin-top: 3rem;">
            <div class="card">
              <h3>üìñ The Source is Open</h3>
              <p>The "source code"‚Äîthe human-readable instructions that make the app work‚Äîis available for anyone to see, study, and verify. There are no hidden agendas. You can see exactly how AddressAlarm protects your data because the code is public on GitHub.</p>
            </div>
            <div class="card">
              <h3>ü§ù Freedom &amp; Collaboration</h3>
              <p>You have the freedom to use the software for any purpose and even modify it. This encourages a global community of developers and users to work together, share improvements, and make the tool better for everyone.</p>
            </div>
            <div class="card">
              <h3>üíñ Community Supported</h3>
              <p>This project is not owned by a corporation. It's built and maintained by volunteers and is funded entirely by user donations. This ensures the project's goals will always stay aligned with the users' best interests: privacy, security, and safety.</p>
            </div>
          </div>
        </div>
      </section>

      <section id="developers" class="alternate-bg">
        <div class="section-inner">
          <h2>For Developers &amp; Contributors</h2>
          <p>
            AddressAlarm is a community-driven, <a href="#open-source" class="tooltip">FOSS<span class="tooltip-text">Free and Open Source Software. Click to learn more.</span></a> project licensed under AGPL-3.0. We welcome contributors of all levels.
            Check out the source code, review our coding standards, and help us build the future of on-device safety tools.
          </p>
          <p>
            <a href="CONTRIBUTING.md">Contributing Guide</a> &bull;
            <a href="SECURITY.md">Security Policy</a> &bull;
            <a href="SUPPORT.md">Support Channels</a>
          </p>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div id="music-player">
        <button id="play-music-btn" title="Toggle background music">[ Activate BGM ]</button>
      </div>
      <p>
        Copyright &copy; 2025 TohnJravolta and AddressAlarm Contributors.
        Licensed under the <a href="LICENSE">GNU AGPL v3.0</a>.
      </p>
      <p>
        <a href="PRIVACY_POLICY.md">Privacy Policy</a> &bull;
        <a href="TERMS.md">Terms of Use</a> &bull;
        <a href="https://github.com/TohnJravolta/AAT" target="_blank" rel="noopener">View Source on GitHub</a>
      </p>
    </footer>
    <script>
    document.addEventListener('DOMContentLoaded', (event) => {
        // --- Theme Switcher ---
        const themeSwitcher = document.getElementById('theme-switcher');
        const body = document.body;

        const setTheme = (theme) => {
            if (theme === 'light') {
                body.classList.add('light-mode');
                themeSwitcher.textContent = 'üåô';
                themeSwitcher.title = 'Switch to dark mode';
            } else {
                body.classList.remove('light-mode');
                themeSwitcher.textContent = '‚òÄÔ∏è';
                themeSwitcher.title = 'Switch to light mode';
            }
            if (window.musicEngine && typeof window.musicEngine.applyMood === 'function') {
                window.musicEngine.applyMood(theme);
            }
        };

        themeSwitcher.addEventListener('click', () => {
            const isLight = body.classList.contains('light-mode');
            if (isLight) {
                localStorage.setItem('theme', 'dark');
                setTheme('dark');
            } else {
                localStorage.setItem('theme', 'light');
                setTheme('light');
            }
        });

        // Load saved theme from localStorage
        const savedTheme = localStorage.getItem('theme') || 'dark';
        setTheme(savedTheme);

        // --- Visual Effects ---
        const initVisuals = () => {
            const bouncingLogo = document.getElementById('bouncing-logo');
            if (bouncingLogo) console.log('Bouncing logo animation is active via CSS.');

            const trails = [];
            const numTrails = 15;
            const trailLag = 1.8;
            for (let i = 0; i < numTrails; i++) {
                let trail = document.createElement('div');
                trail.className = 'trail';
                document.body.appendChild(trail);
                trails.push({ el: trail, x: -20, y: -20 });
            }

            let pointerX = -20, pointerY = -20;

            const hexToRgba = (hex, alpha = 1) => {
                let value = hex.replace('#', '');
                if (value.length === 3) {
                    value = value.split('').map(ch => ch + ch).join('');
                }
                const num = parseInt(value, 16);
                const r = (num >> 16) & 255;
                const g = (num >> 8) & 255;
                const b = num & 255;
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            };

            const randomFrom = (arr) => arr[Math.floor(Math.random() * arr.length)];

            const updatePointer = (x, y) => {
                pointerX = x;
                pointerY = y;
            };

            const spawnTapBurst = (x, y) => {
                const isLightMode = body.classList.contains('light-mode');
                const particles = isLightMode ? 14 : 12;
                const darkPalette = ['#00ff9d', '#3dffb0', '#00e676', '#4fffba', '#00c853'];
                const lightPalette = ['#2ecc71', '#7bed9f', '#a8ff9e', '#1abc9c', '#c8ffb5'];
                const palette = isLightMode ? lightPalette : darkPalette;
                const minSize = isLightMode ? 4 : 6;
                const maxSize = isLightMode ? 11 : 16;
                const minGlow = isLightMode ? 6 : 10;
                const maxGlow = isLightMode ? 12 : 18;
                for (let i = 0; i < particles; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'tap-particle';
                    const size = minSize + Math.random() * (maxSize - minSize);
                    const glow = minGlow + Math.random() * (maxGlow - minGlow);
                    const color = randomFrom(palette);
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.left = `${x}px`;
                    particle.style.top = `${y}px`;
                    particle.style.background = color;
                    particle.style.boxShadow = `0 0 ${glow}px ${hexToRgba(color, isLightMode ? 0.45 : 0.6)}`;
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 30 + Math.random() * 35;
                    const dx = Math.cos(angle) * distance;
                    const dy = Math.sin(angle) * distance;
                    particle.style.setProperty('--dx', `${dx}px`);
                    particle.style.setProperty('--dy', `${dy}px`);
                    document.body.appendChild(particle);
                    particle.addEventListener('animationend', () => particle.remove());
                }
            };

            const handleTouch = (event, shouldBurst = false) => {
                if (event.touches && event.touches.length) {
                    const touch = event.touches[0];
                    updatePointer(touch.pageX, touch.pageY);
                    if (shouldBurst) {
                        spawnTapBurst(touch.pageX, touch.pageY);
                    }
                }
            };

            if (window.PointerEvent) {
                document.addEventListener('pointermove', e => {
                    if (e.isPrimary) {
                        updatePointer(e.pageX, e.pageY);
                    }
                }, { passive: true });
                document.addEventListener('pointerdown', e => {
                    if (!e.isPrimary) return;
                    updatePointer(e.pageX, e.pageY);
                    spawnTapBurst(e.pageX, e.pageY);
                });
            } else {
                document.addEventListener('mousemove', e => {
                    updatePointer(e.pageX, e.pageY);
                });
                document.addEventListener('mousedown', e => {
                    updatePointer(e.pageX, e.pageY);
                    spawnTapBurst(e.pageX, e.pageY);
                });
                document.addEventListener('touchstart', e => handleTouch(e, true), { passive: true });
                document.addEventListener('touchmove', handleTouch, { passive: true });
            }

            const animateTrail = () => {
                let prevX = pointerX, prevY = pointerY;
                trails.forEach(p => {
                    const currentX = p.x, currentY = p.y;
                    p.x += (prevX - currentX) / trailLag;
                    p.y += (prevY - currentY) / trailLag;
                    p.el.style.left = p.x + 'px';
                    p.el.style.top = p.y + 'px';
                    prevX = currentX;
                    prevY = currentY;
                });
                requestAnimationFrame(animateTrail);
            };
            animateTrail();
        };
        initVisuals();

        // --- Interactive Music Engine ---
        const musicEngine = {
            audioCtx: null,
            isPlaying: false,
            phase: 0,
            tempo: 120,
            beat: 0,
            nextNoteTime: 0.0,
            scheduleAheadTime: 0.1,
            lookahead: 25.0,
            timerID: null,
            mousePos: { x: 0.5, y: 0.5 },
            scale: [261.63, 293.66, 329.63, 392.0, 440.0, 523.25, 587.33],
            patterns: {
                kick: new Array(16).fill(0),
                hat: new Array(16).fill(0),
                bass: new Array(16).fill(0),
                arp1: new Array(16).fill(0),
                arp2: new Array(16).fill(0),
            },
            config: {
                kick: { startFreq: 150, endFreq: 0.01, decay: 0.5, gain: 1, endGain: 0.01 },
                hat: { cutoff: 10000, gain: 0.2, decay: 0.1 },
                bass: { wave: 'sawtooth', octave: 2, gain: 0.3, decay: 0.2, cutoff: 400 },
                arp: { wave: 'square', gain: 0.15, decay: 0.1, filterBase: 800, filterRange: 2000, delay: 0.75, feedback: 0.4, noteSkew: 1 },
                echo: { multiplier: 2, gain: 0.3, decay: 0.5 },
            },

            moods: {
                dark: {
                    tempo: 92,
                    scale: [220.0, 246.94, 261.63, 293.66, 329.63, 349.23, 392.0],
                    patterns: {
                        kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                        hat: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                        bass: [1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
                        arp1: [0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0],
                        arp2: [0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0],
                    },
                    config: {
                        kick: { startFreq: 120, endFreq: 35, decay: 0.6, gain: 0.9, endGain: 0.01 },
                        hat: { cutoff: 7500, gain: 0.12, decay: 0.18 },
                        bass: { wave: 'sine', octave: 2, gain: 0.22, decay: 0.28, cutoff: 320 },
                        arp: { wave: 'triangle', gain: 0.12, decay: 0.14, filterBase: 600, filterRange: 1500, delay: 0.9, feedback: 0.32, noteSkew: 1.2 },
                        echo: { multiplier: 1.5, gain: 0.22, decay: 0.6 },
                    },
                },
                light: {
                    tempo: 128,
                    scale: [261.63, 293.66, 329.63, 349.23, 392.0, 440.0, 523.25],
                    patterns: {
                        kick: [1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0],
                        hat: [0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1],
                        bass: [1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 0],
                        arp1: [1, 0, 1, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 1, 0],
                        arp2: [1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1],
                    },
                    config: {
                        kick: { startFreq: 160, endFreq: 45, decay: 0.45, gain: 1, endGain: 0.01 },
                        hat: { cutoff: 11000, gain: 0.22, decay: 0.12 },
                        bass: { wave: 'sawtooth', octave: 1.5, gain: 0.32, decay: 0.2, cutoff: 480 },
                        arp: { wave: 'square', gain: 0.18, decay: 0.1, filterBase: 900, filterRange: 2600, delay: 0.65, feedback: 0.42, noteSkew: 0.9 },
                        echo: { multiplier: 2.25, gain: 0.32, decay: 0.45 },
                    },
                },
            },

            init() {
                document.getElementById('play-music-btn').addEventListener('click', () => this.toggle());

                const updateMousePos = (clientX, clientY) => {
                    this.mousePos.x = Math.min(Math.max(clientX / window.innerWidth, 0), 1);
                    this.mousePos.y = Math.min(Math.max(clientY / window.innerHeight, 0), 1);
                };

                if (window.PointerEvent) {
                    document.addEventListener('pointermove', e => {
                        if (e.isPrimary) {
                            updateMousePos(e.clientX, e.clientY);
                        }
                    }, { passive: true });
                } else {
                    document.addEventListener('mousemove', e => {
                        updateMousePos(e.clientX, e.clientY);
                    });
                    document.addEventListener('touchmove', e => {
                        if (e.touches && e.touches.length) {
                            updateMousePos(e.touches[0].clientX, e.touches[0].clientY);
                        }
                    }, { passive: true });
                }
                document.body.addEventListener('click', e => {
                    if (this.isPlaying && e.target.id !== 'play-music-btn') {
                        this.phase = (this.phase + 1) % 6;
                        this.playEcho();
                    }
                });

                this.applyMood(body.classList.contains('light-mode') ? 'light' : 'dark');
            },

            toggle() {
                if (!this.audioCtx) {
                    this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.audioCtx.state === 'suspended') {
                    this.audioCtx.resume();
                }
                this.isPlaying = !this.isPlaying;
                const playBtn = document.getElementById('play-music-btn');
                if (this.isPlaying) {
                    this.beat = 0;
                    this.nextNoteTime = this.audioCtx.currentTime;
                    this.scheduler();
                    this.timerID = setInterval(() => this.scheduler(), this.lookahead);
                    playBtn.textContent = '[ BGM Active ]';
                } else {
                    clearInterval(this.timerID);
                    playBtn.textContent = '[ Activate BGM ]';
                }
            },

            scheduler() {
                while (this.nextNoteTime < this.audioCtx.currentTime + this.scheduleAheadTime) {
                    this.scheduleNote(this.beat, this.nextNoteTime);
                    this.nextNoteTime += 60.0 / this.tempo / 4; // 16th notes
                    this.beat = (this.beat + 1) % 16;
                }
            },

            scheduleNote(beat, time) {
                if (this.phase >= 0 && this.patterns.kick[beat]) this.playKick(time);
                if (this.phase >= 1 && this.patterns.hat[beat]) this.playHat(time);
                if (this.phase >= 2 && this.patterns.bass[beat]) this.playBass(time, beat);
                if (this.phase >= 3 && this.patterns.arp1[beat]) this.playArp(time, 1);
                if (this.phase >= 4 && this.patterns.arp2[beat]) this.playArp(time, 2);
                if (this.phase >= 5) this.updateFilter(time);
            },

            playKick(time) {
                const osc = this.audioCtx.createOscillator();
                const gain = this.audioCtx.createGain();
                const kickConfig = this.config.kick;
                osc.frequency.setValueAtTime(kickConfig.startFreq, time);
                osc.frequency.exponentialRampToValueAtTime(kickConfig.endFreq, time + kickConfig.decay);
                gain.gain.setValueAtTime(kickConfig.gain, time);
                gain.gain.exponentialRampToValueAtTime(kickConfig.endGain, time + kickConfig.decay);
                osc.connect(gain);
                gain.connect(this.audioCtx.destination);
                osc.start(time);
                osc.stop(time + kickConfig.decay);
            },

            playHat(time) {
                const bufferSize = this.audioCtx.sampleRate * 0.1;
                const buffer = this.audioCtx.createBuffer(1, bufferSize, this.audioCtx.sampleRate);
                const output = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;
                const noise = this.audioCtx.createBufferSource();
                noise.buffer = buffer;
                const filter = this.audioCtx.createBiquadFilter();
                filter.type = 'highpass';
                const hatConfig = this.config.hat;
                filter.frequency.value = hatConfig.cutoff;
                const gain = this.audioCtx.createGain();
                gain.gain.setValueAtTime(hatConfig.gain, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + hatConfig.decay);
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(this.audioCtx.destination);
                noise.start(time);
                noise.stop(time + hatConfig.decay);
            },

            playBass(time, beat) {
                const osc = this.audioCtx.createOscillator();
                const bassConfig = this.config.bass;
                osc.type = bassConfig.wave;
                const freq = this.scale[beat % 4] / bassConfig.octave;
                osc.frequency.setValueAtTime(freq, time);
                const gain = this.audioCtx.createGain();
                gain.gain.setValueAtTime(bassConfig.gain, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + bassConfig.decay);
                const filter = this.audioCtx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = bassConfig.cutoff;
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.audioCtx.destination);
                osc.start(time);
                osc.stop(time + bassConfig.decay);
            },

            playArp(time, octave) {
                const osc = this.audioCtx.createOscillator();
                const arpConfig = this.config.arp;
                osc.type = arpConfig.wave;
                const skewedPosition = Math.pow(this.mousePos.y, arpConfig.noteSkew);
                const noteIndex = Math.min(this.scale.length - 1, Math.floor(skewedPosition * this.scale.length));
                const freq = this.scale[noteIndex] * octave;
                osc.frequency.setValueAtTime(freq, time);

                const gain = this.audioCtx.createGain();
                gain.gain.setValueAtTime(arpConfig.gain, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + arpConfig.decay);

                const filter = this.audioCtx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = arpConfig.filterBase + (this.mousePos.x * arpConfig.filterRange);

                const delay = this.audioCtx.createDelay();
                delay.delayTime.value = (60.0 / this.tempo) * arpConfig.delay;
                const feedback = this.audioCtx.createGain();
                feedback.gain.value = arpConfig.feedback;

                osc.connect(filter);
                filter.connect(gain);
                gain.connect(delay);
                delay.connect(feedback);
                feedback.connect(delay);
                gain.connect(this.audioCtx.destination);
                feedback.connect(this.audioCtx.destination);

                osc.start(time);
                osc.stop(time + arpConfig.decay);
            },

            updateFilter(time) {
                // This could be used for a global filter sweep in phase 5/6
                // For now, mouse X control on the arp filter is sufficient
            },

            playEcho() {
                const time = this.audioCtx.currentTime;
                const osc = this.audioCtx.createOscillator();
                osc.type = 'sine';
                const noteIndex = Math.floor(this.mousePos.y * this.scale.length);
                const echoConfig = this.config.echo;
                osc.frequency.setValueAtTime(this.scale[noteIndex] * echoConfig.multiplier, time);
                const gain = this.audioCtx.createGain();
                gain.gain.setValueAtTime(echoConfig.gain, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + echoConfig.decay);
                osc.connect(gain);
                gain.connect(this.audioCtx.destination);
                osc.start(time);
                osc.stop(time + echoConfig.decay);
            },

            applyMood(theme) {
                const moodKey = theme === 'light' ? 'light' : 'dark';
                const mood = this.moods[moodKey];
                if (!mood) return;
                this.tempo = mood.tempo;
                this.scale = mood.scale.slice();
                this.patterns = {
                    kick: mood.patterns.kick.slice(),
                    hat: mood.patterns.hat.slice(),
                    bass: mood.patterns.bass.slice(),
                    arp1: mood.patterns.arp1.slice(),
                    arp2: mood.patterns.arp2.slice(),
                };
                this.config = JSON.parse(JSON.stringify(mood.config));
                if (this.isPlaying && this.audioCtx) {
                    this.nextNoteTime = this.audioCtx.currentTime + 0.05;
                    this.beat = 0;
                }
            }
        };
        window.musicEngine = musicEngine;
        musicEngine.init();
    });
    </script>
  </body>
</html>